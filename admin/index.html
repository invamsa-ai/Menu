<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… MenuNow</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <script src="../js/firebase-config.js"></script>
    
    <style>
        :root {
            --primary: #FF6B00;
            --text: #333;
            --bg: #f4f6f8;
            --white: #fff;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }

        /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
        .fas, .fa-solid { font-family: "Font Awesome 6 Free"; font-weight: 900; }
        .fab, .fa-brands { font-family: "Font Awesome 6 Brands"; font-weight: 400; }

        body { background-color: var(--bg); color: var(--text); }

        .admin-wrapper { display: flex; min-height: 100vh; }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .sidebar {
            width: var(--sidebar-width); background: var(--white); height: 100vh;
            position: fixed; top: 0; right: 0; padding: 2rem 1.5rem;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            z-index: 100; transition: 0.3s;
        }

        .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary); text-align: center; margin-bottom: 3rem; }

        .nav-link {
            display: flex; align-items: center; gap: 15px; padding: 1rem;
            color: #666; text-decoration: none; border-radius: 12px; margin-bottom: 0.8rem;
            transition: 0.3s; cursor: pointer; font-weight: 600;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255, 107, 0, 0.1); color: var(--primary); }
        .nav-link i { font-size: 1.2rem; width: 25px; text-align: center; }

        .logout-btn {
            margin-top: auto; background: #ffe5e5; color: #d32f2f; border: none;
            padding: 1rem; border-radius: 12px; cursor: pointer; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
        }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content { flex: 1; margin-right: var(--sidebar-width); padding: 2rem; transition: 0.3s; }

        .admin-section { display: none; animation: fadeIn 0.4s; }
        .admin-section.active { display: block; }

        .admin-card {
            background: var(--white); padding: 2rem; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 20px;
        }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 1rem; text-align: right; border-bottom: 1px solid #eee; }
        th { color: #888; font-size: 0.9rem; }
        .table-responsive { overflow-x: auto; }

        .form-control {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px;
            outline: none; font-family: 'Cairo', sans-serif;
        }
        .btn-primary {
            background: var(--primary); color: white; border: none; padding: 12px 20px;
            border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s;
        }
        .btn-primary:hover { opacity: 0.9; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ */
        .social-input-group {
            position: relative;
        }
        .social-input-group i {
            position: absolute; top: 50%; right: 15px; transform: translateY(-50%);
            font-size: 1.2rem;
            z-index: 10; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙˆÙ‚ Ø§Ù„Ø­Ù‚Ù„ */
        }
        
        /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¯Ø§Ø®Ù„ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .social-input-group .fa-whatsapp { color: #25D366; }
        .social-input-group .fa-instagram { color: #E1306C; }
        .social-input-group .fa-snapchat { color: #FFFC00; text-shadow: 0 0 1px #000; } /* Ù„ÙˆÙ† Ø£ØµÙØ± Ù…Ø¹ Ø¸Ù„ Ù„ØªÙˆØ¶ÙŠØ­Ù‡ */
        .social-input-group .fa-tiktok { color: #000; }

        .social-input-group input { padding-right: 45px; }

        /* ØªØ¬Ø§ÙˆØ¨ Ø§Ù„Ø¬ÙˆØ§Ù„ */
        @media (max-width: 768px) {
            .admin-wrapper { flex-direction: column; }
            .sidebar {
                width: 100%; height: 70px; bottom: 0; top: auto; right: 0;
                flex-direction: row; justify-content: space-around; align-items: center;
                padding: 0 10px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
                border-top-left-radius: 20px; border-top-right-radius: 20px;
            }
            .logo { display: none; }
            .nav-link { flex-direction: column; gap: 5px; font-size: 0.75rem; padding: 8px; margin: 0; }
            .nav-link i { font-size: 1.3rem; width: auto; }
            .logout-btn { width: auto; padding: 8px; margin: 0; background: transparent; color: #d32f2f; }
            .logout-btn span { display: none; }
            .logout-btn i { font-size: 1.3rem; }
            .main-content { margin-right: 0; padding: 1rem; padding-bottom: 90px; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.2rem; color: var(--primary); gap: 15px;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fas fa-circle-notch fa-spin fa-2x"></i>
        <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>

    <div class="admin-wrapper">
        <div class="sidebar">
            <div class="logo">MenuNow</div>
            
            <a class="nav-link active" onclick="showSection('dashboard', this)">
                <i class="fas fa-chart-pie"></i> <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>
            <a class="nav-link" onclick="showSection('products', this)">
                <i class="fas fa-hamburger"></i> <span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
            </a>
            <a class="nav-link" onclick="showSection('categories', this)">
                <i class="fas fa-layer-group"></i> <span>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
            </a>
            <a class="nav-link" onclick="showSection('settings', this)">
                <i class="fas fa-cog"></i> <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </a>
            
            <button onclick="logout()" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> <span>Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>

        <div class="main-content">
            
            <div id="dashboard" class="admin-section active">
                <h2 style="margin-bottom: 1.5rem;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="stat-card admin-card" style="display:flex; align-items:center; gap:15px;">
                        <div style="background:rgba(255,107,0,0.1); width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--primary); font-size:1.5rem;">
                            <i class="fas fa-box"></i>
                        </div>
                        <div>
                            <div style="color:#888; font-size:0.9rem;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                            <div id="totalProductsCount" style="font-size:1.4rem; font-weight:800;">0</div>
                        </div>
                    </div>
                    <div class="stat-card admin-card" style="display:flex; align-items:center; gap:15px;">
                        <div style="background:rgba(0,123,255,0.1); width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#007bff; font-size:1.5rem;">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div>
                            <div style="color:#888; font-size:0.9rem;">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
                            <div id="totalCategoriesCount" style="font-size:1.4rem; font-weight:800;">0</div>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3><i class="fas fa-qrcode"></i> Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ÙŠÙˆ</h3>
                    <p style="color: #666; margin: 10px 0;">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ÙŠÙˆ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†:</p>
                    <button class="btn-primary" onclick="generateQR()" style="width:100%;">Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
                    <div id="qrContainer" style="margin-top: 1.5rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px;"></div>
                </div>
            </div>

            <div id="products" class="admin-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                    <button class="btn-primary" onclick="document.getElementById('addProductModal').style.display='flex'">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="admin-card">
                        <thead>
                            <tr>
                                <th>ØµÙˆØ±Ø©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø­Ø°Ù</th>
                            </tr>
                        </thead>
                        <tbody id="adminProductsTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="categories" class="admin-section">
                <h2 style="margin-bottom: 1.5rem;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
                <div class="admin-card"> 
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 20px;">
                        <label style="font-weight:700; display:block; margin-bottom:10px;">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newCatName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…..."> 
                            <button class="btn-primary" onclick="addCategory()"><i class="fas fa-check"></i></button>
                        </div>
                    </div>
                    <div id="adminCategoriesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
                </div>
            </div>

            <div id="settings" class="admin-section">
                <h2 style="margin-bottom: 1.5rem;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…</h2>
                <div class="admin-card">
                    <div style="display: grid; gap: 20px;">
                        
                        <h3 style="color:#666; border-bottom:1px solid #eee; padding-bottom:10px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <label style="font-weight:700; display:block; margin-bottom:5px;">Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…</label>
                                <input type="text" id="restName" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…...">
                            </div>
                            <div>
                                <label style="font-weight:700; display:block; margin-bottom:5px;">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                                <input type="text" id="restCurrency" class="form-control" placeholder="Ø±.Ø³">
                            </div>
                            <div>
                                <label style="font-weight:700; display:block; margin-bottom:5px;">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø¹Ù…</label>
                                <select id="restStatus" class="form-control">
                                    <option value="open">ğŸŸ¢ Ù…ÙØªÙˆØ­</option>
                                    <option value="closed">ğŸ”´ Ù…ØºÙ„Ù‚</option>
                                </select>
                            </div>
                        </div>

                        <h3 style="color:#666; border-bottom:1px solid #eee; padding-bottom:10px; margin-top:10px;">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            
                            <div>
                                <label style="font-weight:700; display:block; margin-bottom:5px;">ÙˆØ§ØªØ³Ø§Ø¨</label>
                                <div class="social-input-group">
                                    <i class="fab fa-whatsapp"></i>
                                    <input type="text" id="socialWhatsapp" class="form-control" placeholder="9665xxxxxxxx">
                                </div>
                            </div>

                            <div>
                                <label style="font-weight:700; display:block; margin-bottom:5px;">Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…</label>
                                <div class="social-input-group">
                                    <i class="fab fa-instagram"></i>
                                    <input type="text" id="socialInsta" class="form-control" placeholder="https://instagram.com/...">
                                </div>
                            </div>

                            <div>
                                <label style="font-weight:700; display:block; margin-bottom:5px;">Ø³Ù†Ø§Ø¨ Ø´Ø§Øª</label>
                                <div class="social-input-group">
                                    <i class="fab fa-snapchat"></i>
                                    <input type="text" id="socialSnap" class="form-control" placeholder="https://snapchat.com/...">
                                </div>
                            </div>

                            <div>
                                <label style="font-weight:700; display:block; margin-bottom:5px;">ØªÙŠÙƒ ØªÙˆÙƒ</label>
                                <div class="social-input-group">
                                    <i class="fab fa-tiktok"></i>
                                    <input type="text" id="socialTiktok" class="form-control" placeholder="https://tiktok.com/...">
                                </div>
                            </div>

                        </div>

                        <div style="background:#e3f2fd; padding:15px; border-radius:10px; border:1px solid #90caf9; margin-top:10px;">
                            <label style="font-weight:700; display:block; margin-bottom:5px; color:#1565c0;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label>
                            <select id="orderingStatus" class="form-control">
                                <option value="true">âœ… Ù…ÙØ¹Ù„ (Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨Ø§Øª)</option>
                                <option value="false">â›” Ù…Ø¹Ø·Ù„ (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)</option>
                            </select>
                        </div>

                        <button class="btn-primary" onclick="saveSettings()" style="margin-top:10px; width: 100%;">
                            <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="addProductModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; padding: 20px;">
        <div class="admin-card" style="width:100%; max-width:500px; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem; align-items:center;">
                <h3>Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                <i class="fas fa-times" onclick="document.getElementById('addProductModal').style.display='none'" style="cursor:pointer; font-size:1.5rem; color:#888;"></i>
            </div>
            <form onsubmit="addProduct(event)" style="display:grid; gap:15px;">
                <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="pName" class="form-control" required></div>
                <div><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="pPrice" class="form-control" required></div>
                <div><label>Ø§Ù„Ù‚Ø³Ù…</label><select id="pCategory" class="form-control" required></select></div>
                <div><label>Ø§Ù„ØµÙˆØ±Ø©</label><input type="file" id="imageFile" class="form-control" accept="image/*"></div>
                <button type="submit" class="btn-primary" style="width:100%;">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadDashboardData();
                loadSettings(); 
                document.getElementById('loadingOverlay').style.display = 'none';
            } else {
                window.location.href = '../login.html';
            }
        });

        // ------------------------------------------------------------------
        // Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        // ------------------------------------------------------------------
        function generateQR() {
            if(!currentUser) return;
            
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = ''; 

            const path = window.location.pathname;
            const adminFolderIndex = path.indexOf('/admin/');
            let rootPath = path;
            
            if (adminFolderIndex !== -1) {
                rootPath = path.substring(0, adminFolderIndex); 
            } else {
                rootPath = path.substring(0, path.lastIndexOf('/'));
            }

            if(rootPath === '/') rootPath = '';

            const menuLink = `${window.location.origin}${rootPath}/menu.html?id=${currentUser.uid}`;

            new QRCode(qrContainer, {
                text: menuLink,
                width: 150,
                height: 150,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            const linkElem = document.createElement('div');
            linkElem.style.marginTop = '10px';
            linkElem.innerHTML = `<a href="${menuLink}" target="_blank" style="color:var(--primary); font-weight:bold; word-break:break-all;">${menuLink}</a>`;
            qrContainer.appendChild(linkElem);
        }

        // ------------------------------------------------------------------
        // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        // ------------------------------------------------------------------
        
        function showSection(sectionId, element) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if(element) element.classList.add('active');

            if(sectionId === 'products') loadProducts();
            if(sectionId === 'categories') loadCategories();
        }

        function logout() {
            auth.signOut().then(() => window.location.href = 'login.html');
        }

        // ------------------------------------------------------------------
        // Ø­ÙØ¸ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        // ------------------------------------------------------------------

        async function loadSettings() {
            if (!currentUser) return;
            try {
                const doc = await db.collection('restaurants').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('restName').value = data.name || '';
                    document.getElementById('restCurrency').value = data.currency || '';
                    document.getElementById('restStatus').value = data.status || 'open';
                    document.getElementById('orderingStatus').value = data.ordering_enabled ? 'true' : 'false';

                    if (data.social) {
                        document.getElementById('socialWhatsapp').value = data.social.whatsapp || '';
                        document.getElementById('socialInsta').value = data.social.instagram || '';
                        document.getElementById('socialSnap').value = data.social.snapchat || '';
                        document.getElementById('socialTiktok').value = data.social.tiktok || '';
                    }
                }
            } catch (error) { console.error("Error loading settings:", error); }
        }

        async function saveSettings() {
            const name = document.getElementById('restName').value;
            const currency = document.getElementById('restCurrency').value;
            const status = document.getElementById('restStatus').value;
            const ordering = document.getElementById('orderingStatus').value === 'true';
            
            const social = {
                whatsapp: document.getElementById('socialWhatsapp').value,
                instagram: document.getElementById('socialInsta').value,
                snapchat: document.getElementById('socialSnap').value,
                tiktok: document.getElementById('socialTiktok').value
            };

            const btn = document.querySelector('#settings .btn-primary');
            btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'; btn.disabled = true;

            try {
                await db.collection('restaurants').doc(currentUser.uid).update({
                    name, currency, status, ordering_enabled: ordering, social
                });
                alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸!');
            } catch (e) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸'); }
            finally { btn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'; btn.disabled = false; }
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù…
        async function loadDashboardData() {
            db.collection('products').where('restaurant_id', '==', currentUser.uid).get().then(snap => {
                document.getElementById('totalProductsCount').innerText = snap.size;
            });
            db.collection('categories').where('restaurant_id', '==', currentUser.uid).get().then(snap => {
                document.getElementById('totalCategoriesCount').innerText = snap.size;
            });
        }

        async function addCategory() {
            const name = document.getElementById('newCatName').value;
            if(!name) return;
            await db.collection('categories').add({
                name, restaurant_id: currentUser.uid, created_at: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('newCatName').value = '';
            loadCategories();
        }

        function loadCategories() {
            db.collection('categories').where('restaurant_id', '==', currentUser.uid).onSnapshot(snapshot => {
                const list = document.getElementById('adminCategoriesList');
                const pCat = document.getElementById('pCategory');
                list.innerHTML = ''; pCat.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
                
                snapshot.forEach(doc => {
                    const c = doc.data();
                    list.innerHTML += `<div style="background:#fff; padding:10px; border:1px solid #ddd; border-radius:8px; display:flex; justify-content:space-between;">
                        <span>${c.name}</span>
                        <i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="deleteDoc('categories', '${doc.id}')"></i>
                    </div>`;
                    pCat.innerHTML += `<option value="${doc.id}">${c.name}</option>`;
                });
                document.getElementById('totalCategoriesCount').innerText = snapshot.size;
            });
        }

        function loadProducts() {
            db.collection('products').where('restaurant_id', '==', currentUser.uid).onSnapshot(snapshot => {
                const tbody = document.getElementById('adminProductsTable');
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    tbody.innerHTML += `<tr>
                        <td><img src="${p.image || 'https://via.placeholder.com/50'}" width="50" style="border-radius:5px"></td>
                        <td>${p.name}</td>
                        <td>${p.category_name || '-'}</td>
                        <td>${p.price}</td>
                        <td><i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="deleteDoc('products', '${doc.id}')"></i></td>
                    </tr>`;
                });
                document.getElementById('totalProductsCount').innerText = snapshot.size;
            });
        }

        async function addProduct(e) {
            e.preventDefault();
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;
            const catId = document.getElementById('pCategory').value;
            const catName = document.getElementById('pCategory').options[document.getElementById('pCategory').selectedIndex].text;
            const imgFile = document.getElementById('imageFile').files[0];
            let imageUrl = "";

            await db.collection('products').add({
                name, price, category_id: catId, category_name: catName, image: imageUrl,
                restaurant_id: currentUser.uid, created_at: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            document.getElementById('addProductModal').style.display='none';
            e.target.reset();
        }

        async function deleteDoc(coll, id) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                await db.collection(coll).doc(id).delete();
            }
        }
    </script>
</body>
</html>
